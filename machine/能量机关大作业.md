# 能量机关目标识别与预测

---

## 描述

大符在比赛中有举足轻重的作用，特别是今年规则大改后，激活能量机关所得增益大幅增加，并且激活环数越高，增益越高，最高攻击力加成高达 **500%**。因此拥有高效、准确的能量机关目标识别和预测打击算法对我们取得比赛胜利至关重要。

### 有关信息

能量机关位于大资源岛正上方。能量机关由电机驱动并按照一定规律同步转动。机器人需占领能量机关激活点以激活能量机关。能量机关分为红蓝两侧，一侧为红方能量机关，另一侧为蓝方能量机关。能量机关有五个均匀分布的支架，具体位置和尺寸如下所示：（相关尺寸为辅助说明，实际用处不大）

![能量机关示意图](C:\Users\lybin\AppData\Roaming\Typora\typora-user-images\image-20240113151546423.png)

![能量机关支架尺寸示意图](C:\Users\lybin\AppData\Roaming\Typora\typora-user-images\image-20240113151631111.png)

![能量机关中心标识尺寸图](C:\Users\lybin\AppData\Roaming\Typora\typora-user-images\image-20240113151641613.png)

### 能量机关机制

#### 小能量机关（小符）

比赛开始一分钟后和比赛开始两分三十秒后（即倒计时为5:59 和4:29），能量机关开始旋转，进入可激活状态，能量机关进入可激活状态30 秒后，若其仍未被激活，则将恢复为不可激活状态。若一方小能量机关进入已激活状态，另一方小能量机关立即变为不可激活状态。一方机器人成功激活小能量机关后，该方所有机器人获得25%的防御增益，持续45 秒。小能量机关增益持续期间内，所有英雄、步兵机器人获得的任意经验提高100%，全队在一次小能量机关增益期间内通过此方式最多共获得800 点额外经验。

#### 大能量机关（大符）

比赛开始四分钟、五分十五秒、六分三十秒后（即倒计时2:59、1:44、0:29），能量机关开始旋转，进入可激活状态，能量机关进入可激活状态30 秒后，若其仍未被激活，则将恢复为不可激活状态。大能量机关的每块装甲模块被划分为1~10 环。一方机器人激活大能量机关后，系统将根据其击中的总环数为该方所有机器人提供相应的攻击力和防御增益。同时，激活大能量机关时正在占领能量机关激活点的机器人将获得500 点经验。

#### 旋转策略

红蓝双方能量机关共轴旋转，即红方能量机关顺时针旋转时，蓝方能量机关相应地逆时针旋转（旋转方向以面朝该方能量机关时的旋转方向进行确定）。每局比赛开始前，能量机关旋转方向随机。该局比赛中，能量机关旋转方向保持一致。

- 小能量机关的转速固定为 **1/3 π rad/s**  。
- 大能量机关转速按照三角函数呈周期性变化。速度目标函数为：**spd = a ∗ sin(𝜔 ∗ 𝑡) + 𝑏** ，其中`spd`的单位为 `rad/s`，t 的单位为s，**a 的取值范围为0.780\~1.045，ω的取值范围为1.884\~2.000，b 始终满足 b=2.090 - a** 。每次大能量机关进入可激活状态时，所有参数重置，其中t 重置为0，a 和ω重置为取值范围内任意值。能量机关的实际转速与速度目标函数的时间误差在 500ms 内。

如下图所示，这是一帧正在旋转的能量机关，其中左上侧亮起的扇叶即为待击打扇叶，右下方亮起的扇叶是击打后扇叶状态，需要注意的是**能量机关装甲模块可以精确检测弹丸击打的环数，并在激活后根据所击中的环数亮起相应灯效。**

![image-20240113153105842](C:\Users\lybin\AppData\Roaming\Typora\typora-user-images\image-20240113153105842.png)

![能量机关击打区域示意图](C:\Users\lybin\AppData\Roaming\Typora\typora-user-images\image-20240113153401591.png)

![大能量机关可激活标识示意图](C:\Users\lybin\AppData\Roaming\Typora\typora-user-images\image-20240113153526834.png)

## 基础任务

请你根据所给的信息及视频和图片，利用` OpenCV` 和 `C++` 写出一套能量机关识别算法。

### 要求

1. 可准确识别处于待击打状态的扇叶，并使用 `OpenCV` 旋转矩形标注；
2. 可准确识别待击打扇叶的中心点，并输出中心点在图片中的像素坐标，输出形式不限；
3. 识别形式不限，可以视频也可以图片，有关资料看压缩包文件。

## 进阶任务

请你根据所提供的信息及视频，利用 `OpenCV` 和 `C++` 写出一套针对大能量机关的识别和预测算法。

### 要求

1. 识别形式为视频，有关文件见压缩包；
2. 可准确识别处于待击打状态的扇叶，并使用`OpenCV` 旋转矩形标注；
3. 可准确识别待击打扇叶的中心点，并输出该中心点在世界坐标系中的坐标，有关相机内参见压缩包文件，规定相机坐标系定义如下：右手坐标系，其中 `x `轴指向图像右侧，`y `轴指向图像下方，`z `轴指向相机正前方，原点位于相机光轴与成像平面交点处；
4. 根据自己的算法拟合出该旋转状态下大能量机关的速度函数；
5. 预测下一帧图像待击打扇叶及其中心点所处的位置，并在图像上标注出来，中心点要输出其在世界坐标系下的坐标。

## 相关资料

- 能量机关图片：`img.png`
- 大符旋转视频：`big.mp4`
- 相机内参：`Camera.yaml`

## 说明

将代码上传至自己的 github 仓库，并将仓库链接发到群里